<!DOCTYPE html>
<html lang="cs">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light">
  <title>Kalkulačka projektové dokumentace (PD) — </title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --muted: #334155;
      --text: #e5e7eb;
      --accent: #38bdf8;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #0b1220, #0f172a);
      color: var(--text)
    }

    .container {
      max-width: 1700px;
      margin: 32px auto;
      padding: 20px
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px
    }

    @media(min-width:900px) {
      .grid {
        grid-template-columns: 1.1fr 1fr
      }
    }

    @media print {

      th,
      td {
        white-space: nowrap
      }

      body {
        font-size: 12px;
        background: #fff;
        color: #000
      }

      .card {
        box-shadow: none;
        border-color: #e5e7eb;
        background: #fff
      }
    }

    .card {
      background: rgba(17, 24, 39, .72);
      backdrop-filter: blur(10px);
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35)
    }

    h1 {
      font-size: 28px;
      margin: 0 0 10px;
      letter-spacing: .2px
    }

    p.sub {
      color: #cbd5e1;
      margin: 0 0 18px
    }

    label {
      font-size: 12px;
      color: #cbd5e1;
      display: block;
      margin-bottom: 6px
    }

    input,
    select {
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid #334155;
      background: #0b1220;
      color: var(--text);
      outline: none
    }

    input[type="number"] {
      appearance: textfield
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px
    }

    .btn {
      appearance: none;
      border: 1px solid #334155;
      background: #0b1220;
      color: #e2e8f0;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all .15s ease
    }

    .btn:hover {
      transform: translateY(-1px);
      border-color: #475569
    }

    .btn.primary {
      background: linear-gradient(180deg, #0891b2, #0284c7);
      border-color: transparent
    }

    .btn.ghost {
      background: transparent
    }

    .stack {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px
    }

    .table th,
    .table td {
      border-bottom: 1px dashed #334155;
      padding: 10px 6px;
      text-align: left
    }

    .table th {
      font-size: 12px;
      color: #cbd5e1;
      font-weight: 600
    }

    .right {
      text-align: right
    }

    .muted {
      color: #94a3b8;
      font-size: 12px
    }

    .kpi {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 10px
    }

    .kpi .item {
      background: #0b1220;
      border: 1px solid #1f2937;
      padding: 12px;
      border-radius: 12px
    }

    .kpi .value {
      font-size: 20px;
      font-weight: 700
    }

    .hr {
      height: 1px;
      background: linear-gradient(90deg, transparent, #334155, transparent);
      margin: 14px 0;
      border: none
    }

    details {
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 10px 12px;
      background: #0b1220
    }

    details summary {
      cursor: pointer;
      font-weight: 600
    }

    .footnote {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 6px
    }

    .total {
      font-weight: 800;
      font-size: 22px
    }

    .notice {
      font-size: 12px;
      color: #93c5fd
    }

    .nowrap {
      white-space: nowrap
    }

    .help-badge {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 18px;
      height: 18px;
      margin-left: 6px;
      border-radius: 999px;
      border: 1px solid #334155;
      background: #0b1220;
      color: #cbd5e1;
      font-size: 12px;
      cursor: help;
      position: relative
    }

    .help-badge:hover .help-tip,
    .help-badge:focus-within .help-tip {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto
    }

    .help-tip {
      position: absolute;
      top: 130%;
      right: 0;
      min-width: 600px;
      padding: 10px;
      border-radius: 10px;
      background: #1e293b;
      border: 1px solid #334155;
      color: #e2e8f0;
      font-size: 12px;
      line-height: 1.4;
      opacity: 0;
      transform: translateY(4px);
      transition: all .2s ease;
      pointer-events: none;
      z-index: 10
    }

    .switch {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-size: 13px
    }

    .switch input {
      width: auto
    }

    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px
    }

    @media(max-width:640px) {
      .row {
        grid-template-columns: 1fr
      }

      .grid-3 {
        grid-template-columns: 1fr
      }

      input,
      select {
        padding: 12px 10px
      }
    }

    .inline-options {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap
    }

    .switch label {
      margin: 0
    }

    .row.align-start {
      align-items: flex-start;
    }

    .inline-options {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    #hourlyRate {
      max-width: 160px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <h1>Kalkulačka projektové dokumentace (PD)</h1>
      <p class="sub">Orientační výpočet ceny PD. Nyní s odhadem CIS z parametrů FVE/BESS a UNIKA sazbami.</p>

      <div class="grid">
        <!-- LEFT: Inputs -->
        <section class="card">
          <!-- A) Způsob stanovení CIS -->
          <div class="inline-options">
            <div class="switch">
              <input type="radio" name="cisMode" id="cisModeModel" value="model" checked>
              <label for="cisModeModel">Odhad CIS z FVE/BESS</label>
            </div>
            <div class="switch">
              <input type="radio" name="cisMode" id="cisModeManual" value="manual">
              <label for="cisModeManual">Zadat CIS ručně</label>
            </div>
          </div>

          <!-- B) Model FVE/BESS -->
          <div id="modelBlock" style="margin-top:12px;">
            <div class="row">
              <div>
                <label for="fveKwp">FVE výkon (kWp)</label>
                <input id="fveKwp" type="number" inputmode="decimal" min="0" step="0.1" placeholder="např. 500" />
              </div>
              <div>
                <label for="bessKwh">BESS kapacita (kWh)</label>
                <input id="bessKwh" type="number" inputmode="decimal" min="0" step="0.1" placeholder="např. 1200" />
              </div>
            </div>
            <div class="row" style="margin-top:12px;">
              <div>
                <label for="balancePct">Rezerva na balance-of-plant (%)</label>
                <input id="balancePct" type="number" inputmode="decimal" min="0" step="0.5" value="0" />
              </div>
            </div>

            <details style="margin-top:12px;">
              <summary>Jednotkové ceny (volitelně upravitelné)</summary>
              <div class="grid-3" style="margin-top:12px;">
                <div>
                  <label for="cFveKwp">Cena FVE za 1 kWp (Kč)</label>
                  <input id="cFveKwp" type="number" inputmode="numeric" min="0" step="100" value="28000" />
                </div>
                <div>
                  <label for="cBessFixed">BESS fixní část (Kč)</label>
                  <input id="cBessFixed" type="number" inputmode="numeric" min="0" step="50000" value="5000000" />
                </div>
                <div>
                  <label for="cBessKwh">BESS variabilní (Kč/kWh)</label>
                  <input id="cBessKwh" type="number" inputmode="numeric" min="0" step="50" value="3000" />
                </div>
              </div>
              <div class="muted" style="margin-top:6px">Pozn.: FVE zůstává lineárně dle kWp. BESS je modelován jako
                fixní část + variabilní Kč/kWh. Balance‑of‑plant (trafostanice, kabeláž, konstrukce…) lze pokrýt
                procentem výše.</div>
            </details>
          </div>

          <!-- C) Ruční CIS -->
          <div id="manualBlock" style="display:none;margin-top:12px;">
            <div class="row">
              <div>
                <label for="cis">Celkové investiční náklady (CIS) – Kč (bez DPH)</label>
                <input id="cis" type="number" inputmode="numeric" min="0" step="1000" placeholder="např. 10000000" />
              </div>
              <div>
                <label for="type">Typ stavby</label>
                <div class="stack">
                  <select id="type"></select>
                  <button class="btn" id="addType">+ Nový typ</button>
                </div>
              </div>
            </div>
          </div>

          <!-- D) Společné: typ + sazby -->
          <div class="row" style="margin-top:12px;">
            <div>
              <label for="type2">Typ stavby</label>
              <div class="stack">
                <select id="type2"></select>
                <button class="btn" id="addType2">+ Nový typ</button>
              </div>
            </div>
            <div>
              <label for="coef">Složitost / náročnost (koeficient)</label>
              <input id="coef" type="number" inputmode="decimal" step="0.05" min="0.5" max="2" value="1" />
              <div class="muted">0,8 = jednodušší | 1,0 = běžná | 1,2 = složitější</div>
            </div>
          </div>

          <div class="row align-start" style="margin-top:12px;">
            <div>
              <label>Hodinová sazba
                <span class="muted">(UNIKA / Vlastní)</span>
              </label>
              <div class="inline-options">
                <div class="switch">
                  <input type="radio" name="rateMode" id="rateUnika" value="unika" checked>
                  <label for="rateUnika">UNIKA</label>
                </div>
                <div class="switch">
                  <input type="radio" name="rateMode" id="rateCustom" value="custom">
                  <label for="rateCustom">Vlastní</label>
                </div>
                <input id="hourlyRate" type="number" inputmode="numeric" min="0" step="50" placeholder="např. 1200"
                  disabled />
              </div>
              <div class="muted">V režimu UNIKA je hodinovka řízena typem stavby (viz konstanty). V režimu Vlastní lze
                přepsat.</div>
            </div>
            <div>
              <label for="hourlyCoef">Koeficient profese
                <span class="help-badge" tabindex="0">?
                  <span class="help-tip">
                    Koeficient násobí hodinovou sazbu podle seniority/typu práce:
                    <br><b>1.0</b> běžná profese,
                    <b>0.8–0.9</b> junior,
                    <b>1.2–1.3</b> senior/HIP,
                    <b>1.4–1.6</b> specialista,
                    <b>1.5–2.0</b> expresní termín.
                    <br>Vyšší koeficient ⇒ menší hodinový limit (při stejné ceně z %).
                  </span>
                </span>
              </label>
              <input id="hourlyCoef" type="number" inputmode="decimal" step="0.05" min="0.5" max="2" value="1" />
              <div class="muted">viz: help-tip (?)</div>
            </div>
          </div>

          <div class="hr"></div>

          <details>
            <summary>Procenta podle stupňů PD (upravte dle potřeby)</summary>
            <table class="table" id="stagesTable">
              <thead>
                <tr>
                  <th>Stupeň</th>
                  <th class="right">Podíl z CIS (%)</th>
                  <th class="right">Zahrnout</th>
                </tr>
              </thead>
              <tbody id="stagesBody"></tbody>
            </table>
            <div class="footnote">Tip: Procenta jsou výchozí pro zvolený typ, ale můžete je kdykoli přepsat. Tlačítkem
              níže je uložíte jako výchozí.</div>
          </details>

          <div class="hr"></div>

          <div class="stack">
            <button class="btn primary" id="calculate">Spočítat</button>
            <button class="btn" id="printOffer">Tisk / PDF nabídka</button>
            <button class="btn" id="saveDefaults">Uložit aktuální % a sazby</button>
            <button class="btn" id="resetConfig">Obnovit výchozí</button>
            <span class="notice">Výsledky se přepočítávají průběžně.</span>
          </div>
        </section>

        <!-- RIGHT: Output -->
        <section class="card">
          <h3 style="margin-top:0">Výsledky</h3>

          <div class="kpi">
            <div class="item">
              <div class="muted">CIS (bez DPH)</div>
              <div class="value" id="kpiCis">–</div>
              <div class="muted" id="kpiCisNote"></div>
            </div>
            <div class="item">
              <div class="muted">Koeficient × rezerva</div>
              <div class="value" id="kpiCoef">–</div>
            </div>
            <div class="item">
              <div class="muted">Celkem PD (součet)</div>
              <div class="value" id="kpiTotal">–</div>
            </div>
          </div>

          <table class="table" style="margin-top:16px;" id="resultTable">
            <thead>
              <tr>
                <th>Stupeň</th>
                <th class="right nowrap">% z CIS</th>
                <th class="right nowrap">Cena % (Kč)</th>
                <th class="right nowrap">Hodinový limit (h)</th>
              </tr>
            </thead>
            <tbody id="resultBody"></tbody>
            <tfoot>
              <tr>
                <th class="right" colspan="2">Součet</th>
                <th class="right total" id="resultSum">–</th>
                <th class="right total" id="resultHours">–</th>
              </tr>
            </tfoot>
          </table>

          <div class="hr"></div>

          <div class="muted">
            Pozn.: Jde o orientační odhad dle procenta z CIS. Skutečná cena závisí na rozsahu, BIM koordinaci, termínech
            apod.
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Dialog Nový typ -->
  <template id="typeDialogTpl">
    <div class="card"
      style="position:fixed; inset:0; margin:auto; width:min(560px,92vw); height:auto; z-index:50; border:1px solid #334155;">
      <h3 style="margin-top:0">Přidat nový typ stavby</h3>
      <div class="row">
        <div>
          <label>Název typu</label>
          <input id="newTypeName" placeholder="např. Administrativní budova" />
        </div>
      </div>
      <div class="hr"></div>
      <div>
        <label>Výchozí procenta pro stupně</label>
        <table class="table">
          <thead>
            <tr>
              <th>Stupeň</th>
              <th class="right">% z CIS</th>
            </tr>
          </thead>
          <tbody id="newTypePerc"></tbody>
        </table>
      </div>
      <div class="hr"></div>
      <div class="stack" style="justify-content:flex-end;">
        <button class="btn ghost" id="cancelType">Zrušit</button>
        <button class="btn primary" id="confirmType">Přidat typ</button>
      </div>
    </div>
  </template>

  <footer style="margin-top:40px; text-align:center; font-size:12px; color:#94a3b8;">
    <span id="appVer"></span> – ©Nolzak <span id="year"></span> PD kalkulačka
  </footer>

  <script>
    // ---------- Helpers ----------
    const APP_VER = '1.1.2';
    const el = (id) => document.getElementById(id);
    const num = (v) => parseFloat(String(v).replace(',', '.')) || 0;
    const fmtCZK = (n) => new Intl.NumberFormat('cs-CZ', { style: 'currency', currency: 'CZK', maximumFractionDigits: 0 }).format(n || 0);

    let __calcTimer = null;
    const recalcDebounced = () => { clearTimeout(__calcTimer); __calcTimer = setTimeout(calculate, 300); };

    let __saveTimer = null;
    const saveLastUsedDebounced = () => {
      clearTimeout(__saveTimer);
      __saveTimer = setTimeout(() => {
        // Uložíme jen poslední zadané parametry, ne nastavení typů
        CONFIG.last.unitCosts = {
          cFveKwp: num(el('cFveKwp').value),
          cBessFixed: num(el('cBessFixed').value),
          cBessKwh: num(el('cBessKwh').value),
          balancePct: num(el('balancePct').value)
        };
        CONFIG.last.modelParams = {
          fveKwp: num(el('fveKwp').value),
          bessKwh: num(el('bessKwh').value)
        };
        // Musíme uložit celý CONFIG
        saveConfig(CONFIG);
      }, 800); // Dáme delší timeout než pro výpočet
    };

    // ---------- Konfigurace (stupně PD) ----------
    const STAGES = [
      { key: 'STU', name: 'Studie / návrh' },
      { key: 'DUR', name: 'Dokumentace pro územní řízení (DUR)' },
      { key: 'DSP', name: 'PD pro povolení stavby (DSP)' },
      { key: 'DPS', name: 'PD pro provedení stavby (DPS)' },
      { key: 'AD', name: 'Autorský dozor (AD)' },
    ];

    // UNIKA sazby podle typu
    const UNIKA_RATES = {
      'RD': 700,
      'BD': 700,
      'PRU': 1200,
      'BESS': 1200,
    };

    // Výchozí typy a procenta
    const DEFAULTS = {
      'RD': { label: 'Rodinný dům (RD)', perc: { STU: 0.5, DUR: 0.0, DSP: 1.2, DPS: 1.6, AD: 0.4 }, rateMode: 'unika', rateCustom: 700 },
      'BD': { label: 'Bytový dům (BD)', perc: { STU: 0.6, DUR: 0.6, DSP: 1.4, DPS: 2.0, AD: 0.5 }, rateMode: 'unika', rateCustom: 700 },
      'PRU': { label: 'Průmyslový objekt', perc: { STU: 0.4, DUR: 0.5, DSP: 1.0, DPS: 1.8, AD: 0.4 }, rateMode: 'unika', rateCustom: 1200 },
      'BROWN': { label: 'Brownfield', perc: { STU: 0.4, DUR: 0.5, DSP: 1.2, DPS: 1.8, AD: 0.4 }, rateMode: 'unika', rateCustom: 1200 },
      'BESS': { label: 'BESS', perc: { STU: 0.3, DUR: 0.5, DSP: 0.9, DPS: 1.5, AD: 0.2 }, rateMode: 'unika', rateCustom: 1200 },
    };

    // Jednotkové ceny — startovní defaults
    const DEFAULT_UNIT_COSTS = {
      cFveKwp: 28000,
      cBessFixed: 5000000,
      cBessKwh: 3000,
      balancePct: 0
    };

    const LS_KEY = 'pd_calc_config_v110'; // nový klíč pro v1.1.0

    // ---------- Local storage ----------
    function loadConfig() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        const base = {
          types: structuredClone(DEFAULTS),
          // per-user poslední volby
          last: {
            typeKey: 'BESS',
            rateMode: 'unika',
            cisMode: 'model',
            unitCosts: structuredClone(DEFAULT_UNIT_COSTS),
            modelParams: { fveKwp: 0, bessKwh: 0 }
          }
        };
        if (!raw) return base;
        const cfg = JSON.parse(raw);
        // doplnit případné chybějící typy
        for (const k of Object.keys(DEFAULTS)) {
          if (!cfg.types[k]) cfg.types[k] = structuredClone(DEFAULTS[k]);
          // merge starých typů s novými properties
          cfg.types[k].rateMode ??= 'unika';
          cfg.types[k].rateCustom ??= UNIKA_RATES[k] || 1200;
        }
        cfg.last ??= base.last;
        cfg.last.unitCosts = { ...DEFAULT_UNIT_COSTS, ...(cfg.last.unitCosts || {}) };
        return cfg;
      } catch (e) {
        return { types: structuredClone(DEFAULTS), last: { typeKey: 'BESS', rateMode: 'unika', cisMode: 'model', unitCosts: structuredClone(DEFAULT_UNIT_COSTS), modelParams: { fveKwp: 0, bessKwh: 0 } } };
      }
    }
    function saveConfig(cfg) { localStorage.setItem(LS_KEY, JSON.stringify(cfg)); }

    let CONFIG = loadConfig();

    // ---------- UI populate ----------
    function populateTypeSelects() {
      const s1 = el('type');   // ruční blok (je skrytý podle režimu)
      const s2 = el('type2');  // společný blok
      const entries = Object.entries(CONFIG.types);
      const fill = (sel) => {
        sel.innerHTML = '';
        for (const [key, obj] of entries) {
          const opt = document.createElement('option');
          opt.value = key; opt.textContent = obj.label;
          sel.appendChild(opt);
        }
      };
      fill(s1); fill(s2);
      // nastavit poslední zvolený
      if (CONFIG.last?.typeKey && CONFIG.types[CONFIG.last.typeKey]) {
        s1.value = CONFIG.last.typeKey;
        s2.value = CONFIG.last.typeKey;
      } else {
        s1.selectedIndex = 0; s2.selectedIndex = 0;
        CONFIG.last.typeKey = s2.value;
      }
    }

    function buildStagesTable() {
      const tbody = el('stagesBody');
      tbody.innerHTML = '';
      const typeKey = getTypeKey();
      const current = CONFIG.types[typeKey];

      for (const st of STAGES) {
        const tr = document.createElement('tr');
        const tdName = document.createElement('td'); tdName.textContent = st.name;
        const tdPct = document.createElement('td'); tdPct.className = 'right';
        const inp = document.createElement('input');
        inp.type = 'number'; inp.step = '0.1'; inp.min = '0'; inp.max = '100';
        inp.value = (current.perc[st.key] ?? 0);
        inp.dataset.stage = st.key;
        tdPct.appendChild(inp);
        const tdInclude = document.createElement('td'); tdInclude.className = 'right';
        const chk = document.createElement('input'); chk.type = 'checkbox';
        chk.checked = (current.perc[st.key] ?? 0) > 0; chk.dataset.stage = st.key;
        tdInclude.appendChild(chk);

        tr.appendChild(tdName); tr.appendChild(tdPct); tr.appendChild(tdInclude);
        tbody.appendChild(tr);
      }

      // hodinovka – režim
      const { rateMode, rateCustom } = current;
      if (rateMode === 'custom') {
        el('rateCustom').checked = true;
        el('hourlyRate').disabled = false;
        el('hourlyRate').value = rateCustom || '';
      } else {
        el('rateUnika').checked = true;
        el('hourlyRate').disabled = true;
        el('hourlyRate').value = getUnikaRate(typeKey);
      }
    }

    function getTypeKey() { return el('type2').value || el('type').value; }
    function setTypeKey(key) { if (el('type')) el('type').value = key; if (el('type2')) el('type2').value = key; CONFIG.last.typeKey = key; }

    function gatherPercents() {
      const rows = el('stagesBody').querySelectorAll('tr');
      const out = {}; const include = {};
      rows.forEach(r => {
        const pct = num(r.querySelector('input[type="number"]').value || '0');
        const stage = r.querySelector('input[type="number"]').dataset.stage;
        const on = r.querySelector('input[type="checkbox"]').checked;
        out[stage] = pct; include[stage] = on;
      });
      return { perc: out, include };
    }

    function getUnikaRate(typeKey) {
      return UNIKA_RATES[typeKey] ?? 1200;
    }

    function getRateForCalc() {
      const typeKey = getTypeKey();
      const t = CONFIG.types[typeKey];
      if (t.rateMode === 'custom') {
        return num(t.rateCustom);
      }
      return getUnikaRate(typeKey);
    }

    function currentCIS() {
      const cisMode = getCisMode();
      if (cisMode === 'manual') {
        const cis = num(el('cis').value);
        return { value: cis, note: 'Ručně zadáno' };
      }
      // model
      const kWp = num(el('fveKwp').value);
      const kWh = num(el('bessKwh').value);
      const cFVE = num(el('cFveKwp').value);
      const cKWh = num(el('cBessKwh').value);
      const bal = num(el('balancePct').value);

      const fixed = num(el('cBessFixed').value);
      const priceBess = fixed + (kWh * cKWh);
      const base = kWp * cFVE + priceBess;
      const cis = base * (1 + bal / 100);
      let note = `Odhad: FVE ${kWp || 0} kWp × ${fmtCZK(cFVE)} + BESS: ${fmtCZK(fixed)} + ${kWh || 0} kWh × ${fmtCZK(cKWh)}${bal ? ` + ${bal}% BoP` : ''}`;
      return { value: cis, note };
    }

    function getCisMode() {
      return (el('cisModeManual').checked) ? 'manual' : 'model';
    }

    function calculate() {
      const { perc, include } = gatherPercents();
      const typeKey = getTypeKey();

      const cisObj = currentCIS();
      const cis = cisObj.value;

      const coef = num(el('coef').value);
      const reserve = 0; // teď nepoužíváme zvláštní rezervu mimo BoP, případně lze vrátit pole
      const hourlyRate = getRateForCalc();
      const hourlyCoef = num(el('hourlyCoef').value);

      // výsledky
      const resultBody = el('resultBody'); resultBody.innerHTML = '';
      let totalPrice = 0, totalHours = 0;

      for (const st of STAGES) {
        const p = (include[st.key] ? (perc[st.key] || 0) : 0);
        const pricePercent = (cis * (p / 100)) * coef * (1 + reserve / 100);
        const hoursBudget = (hourlyRate > 0 && hourlyCoef > 0) ? (pricePercent / (hourlyRate * hourlyCoef)) : 0;

        if (include[st.key] && p > 0) {
          totalPrice += pricePercent;
          totalHours += hoursBudget;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${st.name}</td>
          <td class="right">${p.toLocaleString('cs-CZ', { maximumFractionDigits: 2 })}%</td>
          <td class="right">${fmtCZK(pricePercent)}</td>
          <td class="right">${hoursBudget.toLocaleString('cs-CZ', { maximumFractionDigits: 1 })}</td>`;
        resultBody.appendChild(tr);
      }

      // KPI
      el('kpiCis').textContent = fmtCZK(cis);
      el('kpiCisNote').textContent = cisObj.note || '';
      el('kpiCoef').textContent = `${coef.toLocaleString('cs-CZ', { maximumFractionDigits: 2 })} × ${hourlyCoef.toLocaleString('cs-CZ', { maximumFractionDigits: 2 })} (${CONFIG.types[typeKey].rateMode === 'unika' ? 'UNIKA' : 'Vlastní'}: ${fmtCZK(hourlyRate)}/h)`;
      el('kpiTotal').textContent = fmtCZK(totalPrice);
      el('resultSum').textContent = fmtCZK(totalPrice);
      el('resultHours').textContent = totalHours.toLocaleString('cs-CZ', { maximumFractionDigits: 1 });
    }

    function openNewTypeDialog(targetSelectId) {
      const tpl = el('typeDialogTpl');
      const node = tpl.content.cloneNode(true);
      document.body.appendChild(node);
      const dlg = document.body.lastElementChild;
      const tbody = dlg.querySelector('#newTypePerc'); tbody.innerHTML = '';

      for (const st of STAGES) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${st.name}</td><td class="right"><input type="number" step="0.1" min="0" max="100" value="0" data-stage="${st.key}"/></td>`;
        tbody.appendChild(tr);
      }
      dlg.querySelector('#cancelType').onclick = () => dlg.remove();
      dlg.querySelector('#confirmType').onclick = () => {
        const name = dlg.querySelector('#newTypeName').value?.trim();
        if (!name) { alert('Zadejte název typu.'); return; }
        const key = name.toUpperCase().normalize('NFD').replace(/[^A-Z0-9]+/g, '').slice(0, 6) || `TYP${Math.random().toString(36).slice(2, 6)}`;
        const perc = {};
        dlg.querySelectorAll('input[data-stage]').forEach(i => perc[i.dataset.stage] = num(i.value || '0'));
        CONFIG.types[key] = { label: name, perc, rateMode: 'unika', rateCustom: 1200 };
        saveConfig(CONFIG);
        populateTypeSelects();
        setTypeKey(key);
        buildStagesTable();
        calculate();
        dlg.remove();
      };
    }

    function syncTypeSelects(e) {
      const key = e.target.value;
      setTypeKey(key);
      buildStagesTable();
      calculate();
    }

    function onRateModeChange() {
      const typeKey = getTypeKey();
      const t = CONFIG.types[typeKey];
      const mode = el('rateCustom').checked ? 'custom' : 'unika';
      t.rateMode = mode;
      if (mode === 'custom') {
        el('hourlyRate').disabled = false;
        // ponechat uložený rateCustom, nebo vyplnit aktuální hodnotu
      } else {
        el('hourlyRate').disabled = true;
        el('hourlyRate').value = getUnikaRate(typeKey);
      }
      saveConfig(CONFIG);
      calculate();
    }

    function onHourlyRateInput() {
      const typeKey = getTypeKey();
      const t = CONFIG.types[typeKey];
      t.rateCustom = num(el('hourlyRate').value);
      saveConfig(CONFIG);
      recalcDebounced();
    }

    function onCisModeChange() {
      const mode = getCisMode();
      CONFIG.last.cisMode = mode;
      el('modelBlock').style.display = (mode === 'model') ? '' : 'none';
      el('manualBlock').style.display = (mode === 'manual') ? '' : 'none';
      saveConfig(CONFIG);
      calculate();
    }

    function saveDefaults() {
      const key = getTypeKey();
      const { perc } = gatherPercents();
      CONFIG.types[key].perc = perc;
      // sazby
      CONFIG.types[key].rateMode = el('rateCustom').checked ? 'custom' : 'unika';
      if (CONFIG.types[key].rateMode === 'custom') {
        CONFIG.types[key].rateCustom = num(el('hourlyRate').value);
      }

      // ODEBRÁNO: ukládání CONFIG.last.unitCosts a CONFIG.last.modelParams
      // Ty se teď ukládají automaticky při změně (viz saveLastUsedDebounced)

      saveConfig(CONFIG);
      // Zpřesnili jsme hlášku, aby bylo jasné, co se uložilo:
      alert('Uloženo: Výchozí procenta a sazby pro typ "' + CONFIG.types[key].label + '"');
    }
    el('resetConfig').addEventListener('click', () => {
      if (confirm('Smazat uložené nastavení a načíst nové výchozí hodnoty?')) {
        localStorage.removeItem(LS_KEY);
        CONFIG = loadConfig();
        populateTypeSelects();
        buildStagesTable();
        calculate();
      }
    });

    function printOffer() {
      const typeKey = getTypeKey();
      const typeLabel = CONFIG.types[typeKey]?.label || typeKey;

      const { perc, include } = gatherPercents();
      const cisObj = currentCIS();
      const cis = cisObj.value;
      const coef = num(el('coef').value);
      const hourlyCoef = num(el('hourlyCoef').value);
      const rateMode = CONFIG.types[typeKey].rateMode;
      const hourlyRate = getRateForCalc();
      
      // OPRAVA: Přidána proměnná 'reserve', aby byl výpočet shodný s 'calculate'
      const reserve = 0; // Zatím 0, stejně jako v 'calculate'

      let html = `<!doctype html><html lang="cs"><head><meta charset="utf-8"><title>Nabídka PD</title>
        <style>
          body{font-family:system-ui,Segoe UI,Roboto; margin:40px;}
          h1{margin:0 0 6px;}
          .muted{color:#475569}
          table{width:100%; border-collapse:collapse; margin-top:16px}
          th,td{border-bottom:1px solid #e2e8f0; padding:8px 6px; text-align:left}
          tfoot th{text-align:right}
          .right{text-align:right}
          .total{font-weight:800}
          .note{margin-top:10px; color:#475569; font-size:12px}
        </style></head><body>`;

      html += `<h1>Nabídka – projektová dokumentace</h1>`;
      html += `<div class="muted">Typ: <b>${typeLabel}</b> | CIS: <b>${fmtCZK(cis)}</b> | Koef.: <b>${coef}</b> | Koef. profese: <b>${hourlyCoef}</b></div>`;
      html += `<div class="muted">Sazba: <b>${rateMode === 'unika' ? 'UNIKA' : 'Vlastní'}</b> (${fmtCZK(hourlyRate)}/h)${cisObj.note ? ` | ${cisObj.note}` : ''}</div>`;

      html += `<table><thead>
        <tr>
          <th>Stupeň</th>
          <th class='right'>% z CIS</th>
          <th class='right'>Cena (Kč)</th>
          <th class='right'>Hodinový limit (h)</th>
        </tr>
      </thead><tbody>`;

      let sum = 0, sumHours = 0;
      for (const st of STAGES) {
        if (!include[st.key]) continue;
        const p = perc[st.key] || 0;
        
        // OPRAVA: Výpočet sjednocen s 'calculate' (přidáno * (1 + reserve / 100))
        const price = (cis * (p / 100)) * coef * (1 + reserve / 100);
        
        const hours = (hourlyRate > 0 && hourlyCoef > 0) ? (price / (hourlyRate * hourlyCoef)) : 0;
        sum += price; sumHours += hours;
        html += `<tr>
          <td>${st.name}</td>
          <td class='right'>${p.toLocaleString('cs-CZ', { maximumFractionDigits: 2 })}%</td>
          <td class='right'>${fmtCZK(price)}</td>
          <td class='right'>${hours.toLocaleString('cs-CZ', { maximumFractionDigits: 1 })}</td>
        </tr>`;
      }
      html += `</tbody><tfoot>
        <tr>
          <th class='right' colspan='2'>Součet</th>
          <th class='right total'>${fmtCZK(sum)}</th>
          <th class='right total'>${sumHours.toLocaleString('cs-CZ', { maximumFractionDigits: 1 })}</th>
        </tr>
      </tfoot></table>`;

      html += `<p class='note'>Pozn.: Orientační nabídka bez DPH. Platnost 14 dní, pokud není uvedeno jinak.</p>`;
      html += `</body></html>`;

      const w = window.open('about:blank', '_blank');
      if (!w) { alert('Prohlížeč zablokoval nové okno. Povolit vyskakovací okna pro tuto stránku.'); return; }
      w.document.open(); w.document.write(html); w.document.close();
      w.onload = () => { w.focus(); w.print(); };
    }

   // ---------- Init ----------
   window.addEventListener('DOMContentLoaded', () => {
      el('appVer').textContent = `Verze ${APP_VER}`;
      el('year').textContent = new Date().getFullYear();

      // Naplnit selecty
      populateTypeSelects();
      buildStagesTable();

      // Nastavit poslední režimy/parametry
      if (CONFIG.last?.cisMode === 'manual') { el('cisModeManual').checked = true; }
      onCisModeChange(); // schová/ukáže bloky

      // Jednotkové ceny a parametry modelu
      const uc = CONFIG.last.unitCosts || DEFAULT_UNIT_COSTS;
      el('cFveKwp').value = uc.cFveKwp;
      el('cBessFixed').value = uc.cBessFixed;
      el('cBessKwh').value = uc.cBessKwh;
      el('balancePct').value = uc.balancePct ?? 0;

      const mp = CONFIG.last.modelParams || { fveKwp: 0, bessKwh: 0 };
      el('fveKwp').value = mp.fveKwp || '';
      el('bessKwh').value = mp.bessKwh || '';

      calculate();

      // Eventy
      el('type').addEventListener('change', syncTypeSelects);
      el('type2').addEventListener('change', syncTypeSelects);
      el('addType').addEventListener('click', () => openNewTypeDialog('type'));
      el('addType2').addEventListener('click', () => openNewTypeDialog('type2'));

      el('rateUnika').addEventListener('change', onRateModeChange);
      el('rateCustom').addEventListener('change', onRateModeChange);
      el('hourlyRate').addEventListener('input', onHourlyRateInput); // ukládá se sám v onHourlyRateInput

      el('cisModeManual').addEventListener('change', onCisModeChange);
      el('cisModeModel').addEventListener('change', onCisModeChange);

      // --- ZMĚNA ZDE ---
      // Pole, která jen přepočítávají (ale neukládají se automaticky)
      ['cis', 'coef', 'hourlyCoef']
        .forEach(id => { const n = el(id); if (n) n.addEventListener('input', recalcDebounced); });
      
      // Pole, která přepočítávají A zárověň se automaticky ukládají
      ['fveKwp', 'bessKwh', 'cFveKwp', 'cBessFixed', 'cBessKwh', 'balancePct']
        .forEach(id => { 
            const n = el(id); 
            if (n) {
                n.addEventListener('input', recalcDebounced);
                n.addEventListener('input', saveLastUsedDebounced); // Přidáno automatické ukládání
            }
        });
      // --- KONEC ZMĚNY ---

      // procenta ve stupních
      el('stagesBody').addEventListener('input', (e) => { if (e.target.matches('input')) recalcDebounced(); });

      el('calculate').addEventListener('click', calculate);
      el('saveDefaults').addEventListener('click', saveDefaults);
      el('printOffer').addEventListener('click', printOffer);
    });
  </script>
</body>

</html>